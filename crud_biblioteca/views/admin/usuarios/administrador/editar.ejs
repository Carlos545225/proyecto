<!-- Contenido Principal -->
<div class="container-fluid dashboard-container px-4 py-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title text-verde-oscuro mb-0"><i class="bi bi-pencil-square me-2"></i>Editar Administrador</h5>
                    <a href="/admin/usuarios?tab=administradores" class="btn btn-secondary">Volver</a>
                </div>
                <div class="card-body p-4">
                    <% if (locals.error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    <% } %>
                    <% if (locals.success) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <%= success %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    <% } %>

                    <form action="/admin/usuarios/administrador/editar/<%= administrador.id %>" method="POST" class="needs-validation" novalidate enctype="multipart/form-data" id="editForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre<span class="text-danger">*</span></label>
                                <input type="text" class="form-control <%= locals.errores && errores.nombre ? 'is-invalid' : '' %>" 
                                    id="nombre" name="nombre" value="<%= locals.oldData ? oldData.nombre : administrador.nombre %>" required>
                                <% if (locals.errores && errores.nombre) { %>
                                    <div class="invalid-feedback"><%= errores.nombre %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Por favor ingrese el nombre</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="apellidos" class="form-label">Apellidos<span class="text-danger">*</span></label>
                                <input type="text" class="form-control <%= locals.errores && errores.apellidos ? 'is-invalid' : '' %>" 
                                    id="apellidos" name="apellidos" value="<%= locals.oldData ? oldData.apellidos : administrador.apellidos %>" required>
                                <% if (locals.errores && errores.apellidos) { %>
                                    <div class="invalid-feedback"><%= errores.apellidos %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Por favor ingrese los apellidos</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_documento" class="form-label">Tipo de Documento<span class="text-danger">*</span></label>
                                <select class="form-select <%= locals.errores && errores.tipo_documento ? 'is-invalid' : '' %>" 
                                    id="tipo_documento" name="tipo_documento" required>
                                    <option value="" disabled>Seleccione un tipo de documento</option>
                                    <option value="CC" <%= (locals.oldData ? oldData.tipo_documento : administrador.tipo_documento) === 'CC' ? 'selected' : '' %>>Cédula de Ciudadanía</option>
                                    <option value="CE" <%= (locals.oldData ? oldData.tipo_documento : administrador.tipo_documento) === 'CE' ? 'selected' : '' %>>Cédula de Extranjería</option>
                                    <option value="TI" <%= (locals.oldData ? oldData.tipo_documento : administrador.tipo_documento) === 'TI' ? 'selected' : '' %>>Tarjeta de Identidad</option>
                                    <option value="PP" <%= (locals.oldData ? oldData.tipo_documento : administrador.tipo_documento) === 'PP' ? 'selected' : '' %>>Pasaporte</option>
                                    <option value="PE" <%= (locals.oldData ? oldData.tipo_documento : administrador.tipo_documento) === 'PE' ? 'selected' : '' %>>Permiso Especial de Permanencia</option>
                                </select>
                                <% if (locals.errores && errores.tipo_documento) { %>
                                    <div class="invalid-feedback"><%= errores.tipo_documento %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Por favor seleccione un tipo de documento</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="numero_documento" class="form-label">Número de Documento<span class="text-danger">*</span></label>
                                <input type="text" class="form-control <%= locals.errores && errores.numero_documento ? 'is-invalid' : '' %>" 
                                    id="numero_documento" name="numero_documento" value="<%= locals.oldData ? oldData.numero_documento : administrador.numero_documento %>" required>
                                <% if (locals.errores && errores.numero_documento) { %>
                                    <div class="invalid-feedback"><%= errores.numero_documento %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Por favor ingrese el número de documento</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email<span class="text-danger">*</span></label>
                                <input type="email" class="form-control <%= locals.errores && errores.email ? 'is-invalid' : '' %>" 
                                    id="email" name="email" value="<%= locals.oldData ? oldData.email : administrador.email %>" required>
                                <% if (locals.errores && errores.email) { %>
                                    <div class="invalid-feedback"><%= errores.email %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Por favor ingrese un email válido</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="password" class="form-label">Nueva Contraseña (opcional)</label>
                                <input type="password" class="form-control <%= locals.errores && errores.password ? 'is-invalid' : '' %>" 
                                    id="password" name="password">
                                <% if (locals.errores && errores.password) { %>
                                    <div class="invalid-feedback"><%= errores.password %></div>
                                <% } %>
                                <small class="text-muted">Dejar en blanco para mantener la contraseña actual</small>
                            </div>
                            <div class="col-md-6">
                                <label for="confirm_password" class="form-label">Confirmar Nueva Contraseña</label>
                                <input type="password" class="form-control <%= locals.errores && errores.confirm_password ? 'is-invalid' : '' %>" 
                                    id="confirm_password" name="confirm_password">
                                <% if (locals.errores && errores.confirm_password) { %>
                                    <div class="invalid-feedback"><%= errores.confirm_password %></div>
                                <% } else { %>
                                    <div class="invalid-feedback">Las contraseñas no coinciden</div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control <%= locals.errores && errores.telefono ? 'is-invalid' : '' %>" 
                                    id="telefono" name="telefono" value="<%= locals.oldData ? oldData.telefono : administrador.telefono %>">
                                <% if (locals.errores && errores.telefono) { %>
                                    <div class="invalid-feedback"><%= errores.telefono %></div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control <%= locals.errores && errores.fecha_nacimiento ? 'is-invalid' : '' %>" 
                                    id="fecha_nacimiento" name="fecha_nacimiento" value="<%= locals.oldData ? oldData.fecha_nacimiento : administrador.fecha_nacimiento %>">
                                <% if (locals.errores && errores.fecha_nacimiento) { %>
                                    <div class="invalid-feedback"><%= errores.fecha_nacimiento %></div>
                                <% } %>
                            </div>
                            <div class="col-12">
                                <label for="direccion" class="form-label">Dirección</label>
                                <textarea class="form-control <%= locals.errores && errores.direccion ? 'is-invalid' : '' %>" 
                                    id="direccion" name="direccion" rows="2"><%= locals.oldData ? oldData.direccion : administrador.direccion %></textarea>
                                <% if (locals.errores && errores.direccion) { %>
                                    <div class="invalid-feedback"><%= errores.direccion %></div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="foto_perfil" class="form-label">Foto de Perfil</label>
                                <input type="file" class="form-control <%= locals.errores && errores.foto_perfil ? 'is-invalid' : '' %>" 
                                    id="foto_perfil" name="foto_perfil" accept="image/*">
                                <small class="text-muted">Formatos aceptados: JPG, PNG (máx. 2MB)</small>
                                <% if (locals.errores && errores.foto_perfil) { %>
                                    <div class="invalid-feedback"><%= errores.foto_perfil %></div>
                                <% } %>
                                <% if (administrador.foto_perfil && administrador.foto_perfil !== 'default.png') { %>
                                    <div class="mt-2">
                                        <img src="/uploads/usuarios/<%= administrador.foto_perfil %>" alt="Foto actual" class="img-thumbnail" style="max-height: 100px;">
                                        <small class="d-block text-muted mt-1">Foto actual</small>
                                    </div>
                                <% } %>
                            </div>
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-verde-medio text-white"><i class="bi bi-save me-2"></i>Actualizar Administrador</button>
                                <a href="/admin/usuarios?tab=administradores" class="btn btn-outline-secondary ms-2"><i class="bi bi-x-circle me-2"></i>Cancelar</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Validación del formulario
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                // Validar que las contraseñas coincidan solo si se ingresó una nueva contraseña
                var password = document.getElementById('password');
                var confirmPassword = document.getElementById('confirm_password');
                if (password.value || confirmPassword.value) {
                    if (password.value !== confirmPassword.value) {
                        confirmPassword.setCustomValidity('Las contraseñas no coinciden');
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        confirmPassword.setCustomValidity('');
                    }
                }
                
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // Validación de archivo de imagen
    document.getElementById('foto_perfil').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validar tipo de archivo
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                this.setCustomValidity('Solo se permiten archivos JPG y PNG');
                return;
            }
            
            // Validar tamaño (2MB)
            if (file.size > 2 * 1024 * 1024) {
                this.setCustomValidity('El archivo no debe superar los 2MB');
                return;
            }
            
            this.setCustomValidity('');
        }
    });

    // Depuración del formulario
    document.getElementById('editForm').addEventListener('submit', function(e) {
        console.log('Formulario enviado');
        const formData = new FormData(this);
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
    });
</script>

